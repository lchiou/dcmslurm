# dcmslurm
Tools for estimating SPM dynamic causal modeling (DCM) parameters on a Slurm-managed cluster

### MATLAB scripts

- **dcmslurm_aggregate.m** Given the location of all output files, aggregate all results into a single structure array.
- **dcmslurm_Y_is_nan.m** Determines whether any entires of a matrix are NaN.
- **dcmslurm_ttest.m** Displays statistically significant weights for DCM output parameters. The statistically significant weights are saved in path_output. (t-testing should be used as a preliminary measure only.)
- **dcmslurm_stats.m** Given a single structure array generated by dcmslurm_aggregate, computes confidence intervals for the F values.
- **dcmslurm_estimate.m** Fits DCM parameters for subjects.
- **dcmslurm_favg.m** Computes the mean free energy for a given range of subjects and conditions.
- **dcmslurm_parse.m** Loads a MATLAB file and writes the directory structure (with conditions specified by labels) needed for dcmslurm_estimate. 
- **dcmslurm_parsefile.m** Parses a loaded MATLAB data file data_in and writes the directory structure (with conditions specified by labels) needed for ```dcmslurm_estimate```. 

### Python scripts

- **dcmslurm_make_params.py** This module generates a list of input parameters using which to generate the
job scripts.
- **dcmslurm_make.py** This module generates scripts to run spectral DCM on a SLURM cluster.
- **dcmslurm_check.py** Check a directory containing batch files and logs to determine if and which jobs need to be re-run. Produces a script for re-running failed jobs.

Typical usage is to call ```make_scripts_all.py``` in a script in which the relevant keywords are given and the parameters are defined in a separate script. Generally, parameters are generated using the ```dcmslurm_make_params.py``` module. The master shell script generated can then be run. The ```dcmslurm_check.py``` module is useful for determine which jobs (if any) need to be re-run.

An example script follows below.

```
path_dcmslurm = '/home/usr/dcm/dcmslurm'
path_spm = '/home/usr/dcm/spm12beta'

path_raw = '/scratch/users/usr/dcm_data'
path_raw_file = '/scratch/users/usr/dcm_data/brain_data.mat'
path_parsed = '/scratch/users/usr/dcm_data/brain_data_parsed'

import os
import sys
sys.path.append(path_dcmslurm)
from dcmslurm_make import make_scripts_all
from dcmslurm_make_params import make_params

directory_output = '/scratch/users/usr/dcm_data/brain_data_output'
prefix_output = 'brain_data'

path_params_list = make_params( \
	filename='%s_params' % prefix_output, \
	path_output=os.path.dirname(path_parsed), \
	n_in=5, \
	free_connects=1, \
	self_connect=True, \
	dominant_nodes=[1])

for i in range(len(path_params_list)):
	make_scripts_all(
		path_params = path_params_list[i], \
		directory_output = directory_output, \
		prefix_output = '%s_%s' % (prefix_output, str(i+1)), \
		path_dcmslurm = path_dcmslurm, \
		path_spm = path_spm, \
		path_raw = path_raw, \
		path_raw_file = path_raw_file, \
		path_parsed = path_parsed, \
		save_in_path_parsed = 'false', \
		labels = "{'cond 1', 'cond 2', 'cond 3'}", \
		subjects = 16, \
		em_steps_max = 150, \
		time = '00:10:00', \
		email = 'user@email.com', \
		partition = 'normal', \
		nodes = 1, \
		memory = 700, \
		overwrite = True)
   ```
